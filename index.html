<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soy Tom√© - Super App</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LEAFLET CSS (MAPAS) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- CONFIGURACI√ìN DE ESTILO -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Playfair Display', 'serif'] },
                    colors: { 
                        gold: { 300: '#fde047', 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706', 700: '#b45309', 800: '#92400e' }, 
                        whatsapp: '#25D366',
                        brand: { bg: '#050505', card: '#1a1a1a', accent: '#6366f1' }
                    },
                    animation: {
                        'liquid-gold': 'liquid 15s ease infinite',
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'vibrate': 'vibrate 0.3s linear infinite',
                        'blink-random': 'blinkRandom 4s infinite',
                        'spin-slow': 'spin 4s linear infinite',
                        'float': 'float 6s ease-in-out infinite'
                    },
                    keyframes: {
                        liquid: { '0%': { backgroundPosition: '0% 50%' }, '50%': { backgroundPosition: '100% 50%' }, '100%': { backgroundPosition: '0% 50%' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pulseGlow: { '0%, 100%': { boxShadow: '0 0 15px rgba(245, 158, 11, 0.3)' }, '50%': { boxShadow: '0 0 30px rgba(245, 158, 11, 0.7)' } },
                        vibrate: { '0%': { transform: 'translate(0)' }, '20%': { transform: 'translate(-1px, 1px)' }, '40%': { transform: 'translate(-1px, -1px)' }, '60%': { transform: 'translate(1px, 1px)' }, '80%': { transform: 'translate(1px, -1px)' } },
                        blinkRandom: { '0%, 90%, 100%': { height: '0' }, '95%': { height: '100%' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        spin: { from: { transform: 'rotate(0deg)' }, to: { transform: 'rotate(360deg)' } }
                    }
                }
            }
        }
    </script>

    <!-- IMPORT MAP -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- LEAFLET JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #050505; color: #fff; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        .system-sleeping { filter: grayscale(100%) brightness(0.6) contrast(1.1); transition: filter 1.5s ease; cursor: pointer; }
        .system-awake { filter: grayscale(0%) brightness(1); transition: filter 0.8s ease; }
        
        .bg-liquid-gold {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(-45deg, #0f0f0f, #1a1a1a, #271a00, #451a03);
            background-size: 400% 400%;
            animation: liquid-gold 15s ease infinite;
        }

        .glass-dark { background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-gold { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(245, 158, 11, 0.15); }
        .diadema { background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(25px); border-bottom: 1px solid rgba(251, 191, 36, 0.2); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.8); }
        .btn-premium { background: linear-gradient(135deg, #b45309, #f59e0b); color: black; box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); border: 1px solid #fcd34d; }
        .whatsapp-float { position: fixed; top: 50%; right: 0; transform: translateY(-50%); z-index: 50; background: #25D366; padding: 12px; border-top-left-radius: 12px; border-bottom-left-radius: 12px; box-shadow: 0 0 20px rgba(37, 211, 102, 0.4); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Map Styles */
        .leaflet-container { width: 100%; height: 100%; background: #1a1a1a; z-index: 0; }
        .pin-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.2s; }
        .pin-wrapper:hover { transform: scale(1.1); z-index: 1000; }
        .pin-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 2px solid #fcd34d; }
        .pin-shadow { width: 12px; height: 4px; background: rgba(0,0,0,0.5); border-radius: 50%; margin-top: 2px; filter: blur(2px); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .rich-text p { margin-bottom: 0.8em; color: #a1a1aa; line-height: 1.6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Settings, ShoppingBag, Music, Home, Menu, X, Plus, Trash2, Edit3, Image, Lock, Play, Pause, SkipForward, SkipBack, Share2, MapPin, DollarSign, Loader2, ShoppingCart, User, Minus, Calendar, ExternalLink, Package, ArrowLeft, Save, Siren, Shield, Flame, Dog, FileText, AlertTriangle, RefreshCw, Navigation, LogIn, LogOut } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, getDoc, increment, setDoc } from 'firebase/firestore';
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'firebase/auth';

        // ---------------------------------------------------------
        // 1. CONFIGURACI√ìN DE FIREBASE
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "", // PEGA AQU√ç TU API KEY
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        // Inicializaci√≥n segura
        let db = null;
        let auth = null;
        
        try {
            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // No forzamos anonymous aqu√≠ para permitir login real con Google si se usa
            } else {
                console.warn("‚ö†Ô∏è FALTA CONFIGURACI√ìN: Firebase no est√° activo.");
            }
        } catch (e) {
            console.error("Firebase Error:", e);
        }

        // --- UTILS ---
        const formatCLP = (val) => new Intl.NumberFormat('es-CL', {style:'currency', currency:'CLP'}).format(val);
        
        const compressImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new window.Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = 800 / img.width;
                    canvas.width = 800; canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                }
            }
        });

        const fixSunoLink = (url) => {
            if (!url) return '';
            if (url.includes('/embed/')) return url;
            try {
                const parts = url.split('/song/');
                if (parts.length > 1) {
                    const idPart = parts[1].split('?')[0]; 
                    const id = idPart.split('/')[0];
                    return `https://suno.com/embed/${id}`;
                }
            } catch (e) { console.error("Error link", e); }
            return url;
        };

        const safeLoad = (key, def) => {
            try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; }
        };

        const REPORT_TYPES = [
            { id: 'accident', label: 'Accidente', icon: Siren, color: '#ef4444' },
            { id: 'fire', label: 'Incendio', icon: Flame, color: '#f97316' },
            { id: 'security', label: 'Seguridad', icon: Shield, color: '#3b82f6' },
            { id: 'pet', label: 'Mascota', icon: Dog, color: '#eab308' },
            { id: 'docs', label: 'Documentos', icon: FileText, color: '#a855f7' },
            { id: 'other', label: 'Otro', icon: AlertTriangle, color: '#64748b' },
        ];

        // --- DATA INICIAL ---
        const DEFAULT_ZONES = [{ name: 'Tom√© Centro', price: 2000 }, { name: 'Dichato', price: 3500 }];
        const DEFAULT_CONFIG = { heroTitle: 'SOY TOM√â', heroSubtitle: 'Conectando la Comuna', logoUrl: '', phone: '', social: { whatsapp: '' } };
        const DEFAULT_CONTENT = {
            categories: ['Noticias', 'Eventos', 'Productos'],
            posts: [], 
            music: [{ id: 1, title: 'Bienvenida a Tom√©', sunoUrl: 'https://suno.com/embed/5c357731-8637-4581-965a-063812826723' }],
            zones: DEFAULT_ZONES
        };

        // --- HOOKS ---
        const useFirebaseData = (collectionName, defaultValue) => {
            const [data, setData] = useState(defaultValue);
            useEffect(() => {
                if (!db) return;
                const q = query(collection(db, collectionName));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    items.sort((a, b) => b.id - a.id);
                    setData(items);
                });
                return () => unsubscribe();
            }, [collectionName]);
            return data;
        };

        // --- COMPONENTES ---

        const LeafletMap = ({ reports, onMapClick, onMarkerClick, userLoc }) => {
            const mapContainer = useRef(null);
            const mapInstance = useRef(null);
            
            useEffect(() => {
                if (!mapInstance.current && mapContainer.current) {
                    const map = L.map(mapContainer.current, { zoomControl: false, attributionControl: false }).setView([-36.6158, -72.9575], 14);
                    // Dark Matter Tiles for Gold Theme
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);
                    mapInstance.current = map;

                    map.on('click', (e) => onMapClick(e.latlng));
                }

                const map = mapInstance.current;
                if(map) {
                    // Limpiar marcadores antiguos (simple approach)
                    map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
                    
                    reports.forEach(r => {
                        const type = REPORT_TYPES.find(t => t.id === r.type) || REPORT_TYPES[5];
                        const iconHtml = `<div style="display:flex; flex-direction:column; align-items:center;">
                            <div style="width:36px; height:36px; border-radius:50%; background:${type.color}; display:flex; align-items:center; justify-content:center; border:2px solid white; box-shadow:0 4px 10px rgba(0,0,0,0.5);">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>
                            </div>
                        </div>`;
                        const icon = L.divIcon({ html: iconHtml, className: '', iconSize: [40, 40], iconAnchor: [20, 20] });
                        const marker = L.marker([r.lat, r.lng], { icon }).addTo(map);
                        marker.on('click', () => onMarkerClick(r));
                    });
                }
            }, [reports]);

            useEffect(() => {
                if(mapInstance.current && userLoc) mapInstance.current.flyTo([userLoc.lat, userLoc.lng], 16, { duration: 1.5 });
            }, [userLoc]);

            return <div ref={mapContainer} className="w-full h-full" />;
        };

        const TheEye = ({ mousePos, isAwake }) => {
            const eyeRef = useRef(null);
            const [pupil, setPupil] = useState({x:0, y:0});
            useEffect(() => {
                if(!eyeRef.current || !isAwake) return setPupil({x:0,y:0});
                const rect = eyeRef.current.getBoundingClientRect();
                const ang = Math.atan2(mousePos.y - (rect.top + rect.height/2), mousePos.x - (rect.left + rect.width/2));
                const dist = Math.min(rect.width/4, 15);
                setPupil({x: Math.cos(ang)*dist, y: Math.sin(ang)*dist});
            }, [mousePos, isAwake]);
            return (
                <div ref={eyeRef} className="relative w-48 h-28 bg-white rounded-full flex items-center justify-center shadow-[0_0_50px_rgba(255,255,255,0.2)] overflow-hidden transition-transform hover:scale-105 duration-300 animate-float">
                    <div className="w-20 h-20 bg-black rounded-full flex items-center justify-center transition-transform duration-75 shadow-inner" style={{transform: `translate(${pupil.x}px, ${pupil.y}px)`}}>
                        <div className="w-6 h-6 bg-white rounded-full absolute top-3 right-3 opacity-90"></div>
                    </div>
                    <div className={`absolute top-0 w-full h-0 bg-black opacity-20 ${isAwake ? 'animate-blink-random' : ''}`}></div>
                </div>
            );
        };

        const MusicDiadem = ({ tracks, isOpen, onClose }) => {
            const [idx, setIdx] = useState(0);
            const [playing, setPlaying] = useState(false);
            if(!tracks || tracks.length === 0) return null;
            const current = tracks[idx];
            const toggle = () => setPlaying(!playing);
            const next = () => { setIdx((idx + 1) % tracks.length); setPlaying(true); };
            const prev = () => { setIdx((idx - 1 + tracks.length) % tracks.length); setPlaying(true); };
            
            return (
                <div className={`fixed top-0 left-0 w-full z-[100] transition-transform duration-500 ${isOpen ? 'translate-y-0' : '-translate-y-full'}`}>
                    <div className={`diadema pt-safe pb-4 px-4 ${playing ? 'animate-vibrate' : ''}`}>
                        <div className="max-w-3xl mx-auto flex items-center justify-between gap-4">
                            <div className="flex items-center gap-3 overflow-hidden flex-1">
                                <div className={`w-10 h-10 bg-gold-500 rounded-full flex items-center justify-center text-black shadow-lg ${playing ? 'animate-spin-slow' : ''}`}><Music size={18}/></div>
                                <div className="min-w-0">
                                    <h3 className="font-bold text-white truncate text-sm">{current.title}</h3>
                                    <p className="text-[10px] text-gold-500 tracking-widest uppercase font-bold flex items-center gap-1">{playing && <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>}Soy Tom√© Play</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <button onClick={prev} className="text-zinc-400 hover:text-white"><SkipBack size={20}/></button>
                                <button onClick={toggle} className="w-12 h-12 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 transition shadow-lg shadow-white/10">{playing ? <Pause size={20} fill="black"/> : <Play size={20} fill="black" className="ml-1"/>}</button>
                                <button onClick={next} className="text-zinc-400 hover:text-white"><SkipForward size={20}/></button>
                            </div>
                            <div className="flex items-center gap-3 pl-4 border-l border-white/10">
                                <button onClick={onClose} className="text-zinc-500 hover:text-red-500"><X size={18}/></button>
                            </div>
                        </div>
                        {playing && <div className="absolute opacity-0 w-1 h-1 overflow-hidden pointer-events-none"><iframe src={current.sunoUrl} allow="autoplay" width="100" height="100"></iframe></div>}
                    </div>
                </div>
            );
        };

        const NewsModal = ({ post, onClose, addToCart }) => {
            if (!post) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-md" onClick={onClose}></div>
                    <div className="relative w-full max-w-2xl bg-zinc-900 rounded-2xl border border-white/10 shadow-2xl max-h-[90vh] overflow-y-auto animate-fade-in flex flex-col">
                        <div className="p-6">
                            <h1 className="text-3xl font-black text-white mb-4">{post.title}</h1>
                            {post.src?.[0] && <img src={post.src[0]} className="w-full h-64 object-contain bg-black rounded-xl mb-6 border border-white/5" />}
                            {(post.price) && <div className="mb-4 text-gold-500 font-bold text-xl">{formatCLP(post.price)}</div>}
                            <div className="rich-text" dangerouslySetInnerHTML={{__html: post.body}}></div>
                        </div>
                        {post.price && <div className="p-4 border-t border-white/10 flex justify-end gap-3"><button onClick={()=>{addToCart(post); onClose();}} className="bg-gold-500 text-black px-6 py-2 rounded-full font-bold">AGREGAR</button></div>}
                        <button onClick={onClose} className="absolute top-4 right-4 bg-zinc-800 p-2 rounded-full"><X size={20}/></button>
                    </div>
                </div>
            );
        };

        const CreateReportModal = ({ lat, lng, user, onClose }) => {
            const [data, setData] = useState({ type: 'security', desc: '', src: [] });
            
            const handleSubmit = async () => {
                if(!data.desc) return alert("Falta descripci√≥n");
                const report = {
                    ...data, lat, lng,
                    userId: user.uid,
                    date: new Date().toLocaleTimeString(),
                    timestamp: Date.now()
                };
                if(db) {
                    await addDoc(collection(db, 'reports'), report);
                    // XP Logic could go here
                    alert("Reporte enviado!");
                } else {
                    alert("Modo local: Reporte simulado.");
                }
                onClose();
            };

            const handleFile = (e) => {
                const f = e.target.files[0];
                if(f) compressImage(f).then(b64 => setData({...data, src: [b64]}));
            };

            return (
                <div className="fixed inset-0 z-[200] bg-black/80 backdrop-blur flex items-center justify-center p-4">
                    <div className="bg-zinc-900 w-full max-w-sm rounded-2xl p-6 border border-gold-500/30 shadow-2xl">
                        <h3 className="text-xl font-bold text-white mb-4">Nuevo Reporte</h3>
                        <div className="grid grid-cols-3 gap-2 mb-4">
                            {REPORT_TYPES.map(t => (
                                <button key={t.id} onClick={()=>setData({...data, type:t.id})} className={`p-2 rounded border flex flex-col items-center gap-1 ${data.type===t.id ? 'border-gold-500 bg-gold-500/10 text-gold-500' : 'border-zinc-700 text-zinc-500'}`}>
                                    <t.icon size={20}/> <span className="text-[10px] uppercase font-bold">{t.label}</span>
                                </button>
                            ))}
                        </div>
                        <textarea value={data.desc} onChange={e=>setData({...data, desc:e.target.value})} className="w-full bg-black border border-zinc-700 p-3 rounded mb-4 text-white" placeholder="¬øQu√© sucede?" rows="3"></textarea>
                        <div className="flex gap-2">
                             <div className="relative p-3 bg-black border border-zinc-700 rounded text-zinc-500"><input type="file" onChange={handleFile} className="absolute inset-0 opacity-0"/><Settings/></div>
                             <button onClick={handleSubmit} className="flex-1 bg-gold-500 text-black font-bold rounded py-3">ENVIAR REPORTE</button>
                        </div>
                        <button onClick={onClose} className="absolute top-4 right-4 text-zinc-500"><X/></button>
                    </div>
                </div>
            );
        };

        const CartDrawer = ({ isOpen, onClose, cart, setCart, zones, config }) => {
            const [step, setStep] = useState('cart');
            const [data, setData] = useState({ name: '', delivery: 'retiro', address: '' });
            const total = cart.reduce((s,i)=>s+(parseInt(i.price)*i.qty),0);
            
            const sendOrder = () => {
                if(!data.name) return alert("Falta nombre");
                const phone = config.social?.whatsapp;
                let msg = `üõçÔ∏è *PEDIDO*\nüë§ ${data.name}\nüì¶ ${data.delivery}\nüí∞ Total: ${formatCLP(total)}`;
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            };

            const updateQty = (id, d) => setCart(c => c.map(i => i.id===id ? {...i, qty:Math.max(1, i.qty+d)} : i));
            const remove = (id) => setCart(c => c.filter(i => i.id!==id));

            return (
                <div className={`fixed inset-0 z-[200] flex justify-end transition-opacity duration-300 ${isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}>
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
                    <div className={`relative w-full max-w-md h-full bg-zinc-900 flex flex-col transition-transform duration-300 ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                        <div className="p-5 border-b border-white/10 flex justify-between items-center"><h2 className="text-xl font-bold">CARRITO</h2><button onClick={onClose}><X/></button></div>
                        <div className="flex-1 overflow-y-auto p-5 space-y-4">
                            {step==='cart' ? cart.map(i=>(
                                <div key={i.id} className="flex gap-3 bg-white/5 p-3 rounded-xl border border-white/5 items-center">
                                    <div className="w-12 h-12 rounded bg-black overflow-hidden"><img src={i.src[0]} className="w-full h-full object-cover"/></div>
                                    <div className="flex-1"><div className="font-bold text-sm text-white line-clamp-1">{i.title}</div><div className="text-gold-500 font-bold text-xs">{formatCLP(i.price)}</div></div>
                                    <div className="flex items-center gap-2"><button onClick={()=>updateQty(i.id,-1)}><Minus size={14}/></button><span className="text-xs">{i.qty}</span><button onClick={()=>updateQty(i.id,1)}><Plus size={14}/></button></div>
                                    <button onClick={()=>remove(i.id)} className="text-red-500"><Trash2 size={16}/></button>
                                </div>
                            )) : (
                                <div className="space-y-4">
                                    <input value={data.name} onChange={e=>setData({...data, name:e.target.value})} className="w-full bg-black p-3 rounded text-white border border-zinc-700" placeholder="Tu Nombre"/>
                                    <div className="grid grid-cols-2 gap-2"><button onClick={()=>setData({...data,delivery:'retiro'})} className={`p-3 rounded border ${data.delivery==='retiro'?'bg-gold-500 text-black':'bg-black border-zinc-700'}`}>RETIRO</button><button onClick={()=>setData({...data,delivery:'delivery'})} className={`p-3 rounded border ${data.delivery==='delivery'?'bg-gold-500 text-black':'bg-black border-zinc-700'}`}>DELIVERY</button></div>
                                    {data.delivery==='delivery' && <textarea value={data.address} onChange={e=>setData({...data,address:e.target.value})} className="w-full bg-black p-3 rounded border border-zinc-700 h-24" placeholder="Direcci√≥n..."/>}
                                </div>
                            )}
                        </div>
                        {cart.length>0 && <div className="p-5 border-t border-white/10 bg-black/40"><div className="flex justify-between font-bold text-lg mb-4"><span>TOTAL</span><span>{formatCLP(total)}</span></div>{step==='cart' ? <button onClick={()=>setStep('form')} className="w-full py-4 bg-white text-black font-bold rounded-xl">CONTINUAR</button> : <button onClick={sendOrder} className="w-full py-4 bg-green-600 text-white font-bold rounded-xl">ENVIAR WHATSAPP</button>}</div>}
                    </div>
                </div>
            );
        };

        // --- ADMIN PANEL MAESTRO ---
        const AdminPanel = ({ onClose }) => {
            const [tab, setTab] = useState('posts');
            const [form, setForm] = useState({ title: '', category: 'Noticias', type: 'news', src: [], body: '', price: '', sunoUrl: '' });
            const [localPosts, setLocalPosts] = useState(() => safeLoad('st_cnt_posts', []));
            const [localMusic, setLocalMusic] = useState(() => safeLoad('st_cnt_music', []));
            const cloudPosts = useFirebaseData('posts', []);
            const cloudMusic = useFirebaseData('music', []);
            const postsToShow = db ? cloudPosts : localPosts;
            const musicToShow = db ? cloudMusic : localMusic;
            const [newCat, setNewCat] = useState(''); // Estado para nueva categor√≠a

            // Aseguramos categor√≠as por defecto y permitimos a√±adir nuevas (localmente por ahora)
            const [categories, setCategories] = useState(() => safeLoad('st_cats', DEFAULT_CONTENT.categories));

            const handleFile = (e) => {
                const f = e.target.files[0];
                if(f) compressImage(f).then(b64 => setForm(p=>({...p, src:[b64]})));
            };

            const savePost = async () => {
                if(!form.title) return alert("Falta t√≠tulo");
                const collectionName = form.type === 'music' ? 'music' : 'posts';
                const dataToSave = { ...form, id: Date.now(), date: new Date().toLocaleDateString(), sunoUrl: form.type === 'music' ? fixSunoLink(form.sunoUrl) : null };

                if (db) {
                    try { await addDoc(collection(db, collectionName), dataToSave); alert("Subido!"); } 
                    catch (e) { alert("Error Cloud: " + e.message); }
                } else {
                    if (collectionName === 'music') {
                        const newMusic = [dataToSave, ...localMusic]; setLocalMusic(newMusic); localStorage.setItem('st_cnt_music', JSON.stringify(newMusic));
                    } else {
                        const newPosts = [dataToSave, ...localPosts]; setLocalPosts(newPosts); localStorage.setItem('st_cnt_posts', JSON.stringify(newPosts));
                    }
                    alert("Guardado Localmente");
                }
                setForm({ title: '', category: 'Noticias', type: 'news', src: [], body: '', price: '', sunoUrl: '' });
            };

            const deleteItem = async (id, col) => {
                if(!confirm("¬øBorrar?")) return;
                if (db) { try { await deleteDoc(doc(db, col, id)); } catch(e) { console.error(e); } } 
                else {
                    if (col === 'music') { const newM = localMusic.filter(m => m.id !== id); setLocalMusic(newM); localStorage.setItem('st_cnt_music', JSON.stringify(newM)); } 
                    else { const newP = localPosts.filter(p => p.id !== id); setLocalPosts(newP); localStorage.setItem('st_cnt_posts', JSON.stringify(newP)); }
                }
            };

            const addCategory = () => {
                if(newCat && !categories.includes(newCat)){
                    const newCats = [...categories, newCat];
                    setCategories(newCats);
                    localStorage.setItem('st_cats', JSON.stringify(newCats));
                    setNewCat('');
                }
            };

            return (
                <div className="fixed inset-0 z-[11000] bg-zinc-900 text-white flex flex-col md:flex-row overflow-hidden animate-fade-in">
                    <div className="w-full md:w-64 bg-black p-6 border-r border-white/10 flex flex-col gap-2 shrink-0">
                        <h2 className="text-xl font-black text-gold-500 mb-6 tracking-tight">MAESTRO</h2>
                        <button onClick={()=>setTab('posts')} className="p-3 text-left rounded text-sm font-bold bg-white text-black">CONTENIDO</button>
                        <button onClick={()=>setTab('cats')} className="p-3 text-left rounded text-sm font-bold text-zinc-400 hover:text-white">CATEGOR√çAS</button>
                        <button onClick={onClose} className="mt-auto p-3 bg-red-600 rounded font-bold text-xs">SALIR</button>
                    </div>
                    <div className="flex-1 p-8 overflow-y-auto">
                        {tab === 'posts' && (
                            <div className="max-w-2xl space-y-4">
                                <h3 className="text-2xl font-bold mb-4">Publicar</h3>
                                <select value={form.type} onChange={e=>setForm({...form, type:e.target.value})} className="w-full bg-black p-3 rounded border border-zinc-700">
                                    <option value="news">Noticia</option><option value="product">Producto</option><option value="music">M√∫sica</option>
                                </select>
                                <select value={form.category} onChange={e=>setForm({...form, category:e.target.value})} className="w-full bg-black p-3 rounded border border-zinc-700">
                                    {categories.map(c=><option key={c} value={c}>{c}</option>)}
                                </select>
                                <input value={form.title} onChange={e=>setForm({...form, title:e.target.value})} className="w-full bg-black p-3 rounded border border-zinc-700 font-bold" placeholder="T√≠tulo"/>
                                {form.type === 'product' && <input value={form.price} onChange={e=>setForm({...form, price:e.target.value})} className="w-full bg-black p-3 rounded border border-zinc-700" placeholder="Precio"/>}
                                {form.type === 'music' && <input value={form.sunoUrl} onChange={e=>setForm({...form, sunoUrl:e.target.value})} className="w-full bg-black p-3 rounded border border-zinc-700" placeholder="Link Suno"/>}
                                {form.type !== 'music' && <input type="file" onChange={handleFile} className="w-full bg-black p-3 rounded border border-zinc-700 text-xs"/>}
                                <textarea value={form.body} onChange={e=>setForm({...form, body:e.target.value})} className="w-full bg-black p-3 rounded border border-zinc-700 h-32" placeholder="Contenido..."></textarea>
                                <button onClick={savePost} className="w-full py-4 bg-gold-500 text-black font-black rounded-lg hover:scale-105 transition">PUBLICAR</button>
                                <div className="mt-8"><h4 className="font-bold text-zinc-500 mb-2">√öLTIMOS</h4>{[...postsToShow, ...musicToShow].slice(0, 10).map(p => (<div key={p.id} className="flex justify-between p-3 border-b border-white/5"><span>{p.title}</span><button onClick={()=>deleteItem(p.id, p.type === 'music' ? 'music' : 'posts')} className="text-red-500"><Trash2 size={16}/></button></div>))}</div>
                            </div>
                        )}
                        {tab === 'cats' && (
                            <div className="max-w-md space-y-4">
                                <h3 className="text-2xl font-bold">Categor√≠as</h3>
                                <div className="flex gap-2"><input value={newCat} onChange={e=>setNewCat(e.target.value)} className="flex-1 bg-black p-3 rounded" placeholder="Nueva..."/><button onClick={addCategory} className="bg-white text-black px-4 rounded font-bold">A√ëADIR</button></div>
                                <div className="grid grid-cols-2 gap-2">{categories.map(c=><div key={c} className="p-3 bg-zinc-800 rounded flex justify-between"><span>{c}</span></div>)}</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const cloudPosts = useFirebaseData('posts', []);
            const cloudMusic = useFirebaseData('music', []);
            const localPosts = !db ? safeLoad('st_cnt_posts', DEFAULT_CONTENT.posts) : [];
            const localMusic = !db ? safeLoad('st_cnt_music', DEFAULT_CONTENT.music) : [];
            const posts = db ? cloudPosts : localPosts;
            const music = db ? cloudMusic : localMusic;
            // Cargar categor√≠as guardadas o default
            const categories = safeLoad('st_cats', DEFAULT_CONTENT.categories);

            const [view, setView] = useState('home');
            const [awake, setAwake] = useState(false);
            const [mousePos, setMousePos] = useState({x:0, y:0});
            const [showLogin, setShowLogin] = useState(false);
            const [adminOpen, setAdminOpen] = useState(false);
            const [musicOpen, setMusicOpen] = useState(false);
            const [selectedPost, setSelectedPost] = useState(null);
            const [cartOpen, setCartOpen] = useState(false);
            const [cart, setCart] = useState([]);
            const [filter, setFilter] = useState('Todas');
            
            // Map Logic (Reportes)
            const [userLoc, setUserLoc] = useState(null);
            const cloudReports = useFirebaseData('reports', []);
            const [createLoc, setCreateLoc] = useState(null);
            const [showCreateReport, setShowCreateReport] = useState(false);
            const [authUser, setAuthUser] = useState(null); // Firebase Auth User

            const wakeUp = () => { if(!awake) setAwake(true); };
            
            useEffect(() => {
                const move = (e) => {
                    const x = e.touches ? e.touches[0].clientX : e.clientX;
                    const y = e.touches ? e.touches[0].clientY : e.clientY;
                    if(x && y) setMousePos({x, y});
                };
                window.addEventListener('mousemove', move); window.addEventListener('touchmove', move);
                return () => { window.removeEventListener('mousemove', move); window.removeEventListener('touchmove', move); }
            }, []);

            // Auth Listener
            useEffect(() => {
                if(auth) {
                    return onAuthStateChanged(auth, (u) => { setAuthUser(u); });
                }
            }, []);

            // Geolocation
            useEffect(() => {
                if(view === 'map' && navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(p => setUserLoc({lat: p.coords.latitude, lng: p.coords.longitude}));
                }
            }, [view]);

            const addToCart = (item) => {
                setCart(prev => [...prev, { ...item, qty: 1 }]);
                setCartOpen(true);
            };

            const filteredPosts = posts.filter(p => filter === 'Todas' || p.category === filter);

            const handleMapClick = (latlng) => {
                if(!authUser) { alert("Debes iniciar sesi√≥n para reportar"); setShowLogin(true); return; }
                setCreateLoc(latlng);
                setShowCreateReport(true);
            };

            const loginGoogle = async () => {
                if(!auth) return alert("Firebase no configurado");
                try { await signInWithPopup(auth, new GoogleAuthProvider()); setShowLogin(false); } 
                catch(e) { console.error(e); }
            };

            return (
                <div className={`min-h-screen font-sans text-white ${awake?'system-awake':'system-sleeping'}`} onClick={wakeUp} onTouchStart={wakeUp}>
                    <div className="bg-liquid-gold animate-liquid-gold"></div>

                    {awake && <MusicDiadem tracks={music} isOpen={musicOpen} onClose={()=>setMusicOpen(false)} />}

                    <nav className={`fixed top-0 w-full z-40 p-4 flex justify-between items-center transition-all duration-500 ${musicOpen ? 'translate-y-20' : ''}`}>
                        <div onClick={()=>setView('home')} className="font-black text-2xl tracking-tighter cursor-pointer">ST.</div>
                        <div className="flex gap-4">
                            {cart.length > 0 && <button onClick={(e)=>{e.stopPropagation(); setCartOpen(true)}} className="relative"><ShoppingCart/><span className="absolute -top-1 -right-1 bg-red-600 text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold">{cart.length}</span></button>}
                            <button onClick={(e)=>{e.stopPropagation(); setShowLogin(true)}} className="border border-white/20 px-3 py-1 rounded-full text-xs font-bold backdrop-blur">
                                {authUser ? 'PERFIL' : 'ACCESO'}
                            </button>
                        </div>
                    </nav>

                    {/* WHATSAPP (Solo Home) */}
                    {awake && view === 'home' && (
                        <a href="https://wa.me/56912345678" target="_blank" className="fixed top-1/2 right-0 z-50 transform -translate-y-1/2 bg-whatsapp p-3 rounded-l-xl shadow-lg hover:pl-6 transition-all duration-300">
                            <Share2 className="text-white w-6 h-6"/>
                        </a>
                    )}

                    {view === 'home' && (
                        <main className="min-h-screen flex flex-col items-center justify-center p-6 text-center relative z-10">
                            <TheEye mousePos={mousePos} isAwake={awake} />
                            <h1 className="text-5xl md:text-7xl font-black tracking-tighter text-white drop-shadow-2xl mt-8">SOY TOM√â</h1>
                            <p className="text-gold-400 mt-2 tracking-widest text-sm uppercase">Conectando la Comuna</p>
                            <div className="mt-12 flex flex-wrap justify-center gap-4 w-full max-w-sm">
                                <button onClick={()=>setView('explore')} className="flex-1 py-4 bg-white text-black font-black rounded-2xl hover:scale-105 transition shadow-lg">EXPLORAR</button>
                                <button onClick={()=>setView('map')} className="flex-1 py-4 bg-zinc-800 border border-white/20 font-black rounded-2xl flex items-center justify-center gap-2 hover:bg-zinc-700 transition"><MapPin size={18}/> MAPA</button>
                                <button onClick={(e)=>{e.stopPropagation(); setMusicOpen(true)}} className="w-full py-3 bg-gradient-to-r from-gold-600 to-yellow-500 text-black font-black rounded-full hover:scale-105 transition shadow-lg flex items-center justify-center gap-2"><Music size={18}/> PLAY</button>
                            </div>
                        </main>
                    )}

                    {view === 'explore' && (
                        <main className="pt-32 px-4 pb-20 relative z-10 animate-fade-in">
                            <div className="flex gap-2 overflow-x-auto pb-4 mb-8 no-scrollbar">
                                <button onClick={()=>setFilter('Todas')} className={`px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap transition ${filter==='Todas'?'bg-white text-black':'glass-dark border border-white/20'}`}>TODAS</button>
                                {categories.map(c=><button key={c} onClick={()=>setFilter(c)} className={`px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap transition ${filter===c?'bg-white text-black':'glass-dark border border-white/20'}`}>{c}</button>)}
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {filteredPosts.map(p => (
                                    <div key={p.id} onClick={()=>setSelectedPost(p)} className="glass-dark rounded-2xl overflow-hidden shadow-lg cursor-pointer">
                                        <div className="aspect-video bg-black relative"><img src={p.src?.[0]} className="w-full h-full object-cover opacity-80 hover:opacity-100 transition"/>{p.price && <span className="absolute bottom-2 right-2 bg-gold-500 text-black px-3 py-1 rounded-full text-xs font-bold">${formatCLP(p.price)}</span>}</div>
                                        <div className="p-4"><span className="text-[10px] text-gold-500 font-bold uppercase">{p.category}</span><h3 className="text-lg font-bold leading-tight mt-1">{p.title}</h3></div>
                                    </div>
                                ))}
                            </div>
                            <button onClick={()=>setView('home')} className="fixed bottom-6 left-6 bg-zinc-800 p-3 rounded-full shadow-lg border border-white/10"><ArrowLeft/></button>
                        </main>
                    )}

                    {view === 'map' && (
                        <div className="absolute inset-0 z-0">
                            <LeafletMap reports={cloudReports} userLoc={userLoc} onMapClick={handleMapClick} onMarkerClick={(r)=>alert(r.desc)}/>
                            <button onClick={()=>setView('home')} className="fixed bottom-6 left-6 z-[1000] bg-zinc-900 p-3 rounded-full shadow-lg"><ArrowLeft/></button>
                            <button onClick={()=>{if(!user) setShowLogin(true); else { setCreateLoc(userLoc); setShowCreateReport(true); }}} className="fixed bottom-6 right-6 z-[1000] bg-brand-accent p-4 rounded-full shadow-lg font-bold flex items-center gap-2"><Plus/> REPORTAR</button>
                        </div>
                    )}

                    {/* MODALES */}
                    <NewsModal post={selectedPost} onClose={()=>setSelectedPost(null)} addToCart={addToCart} />
                    <CartDrawer isOpen={cartOpen} onClose={()=>setCartOpen(false)} cart={cart} setCart={setCart} zones={DEFAULT_ZONES} config={DEFAULT_CONFIG} />
                    
                    {showCreateReport && createLoc && <CreateReportModal lat={createLoc.lat} lng={createLoc.lng} user={authUser} onClose={()=>setShowCreateReport(false)} db={db}/>}

                    {showLogin && (
                        <div className="fixed inset-0 z-[1000] bg-black/95 flex items-center justify-center p-4 backdrop-blur" onClick={() => setShowLogin(false)}>
                            <div className="glass-dark p-8 rounded-3xl w-full max-w-sm text-center relative border-t-4 border-gold-600 shadow-2xl" onClick={e => e.stopPropagation()}>
                                {authUser ? (
                                    <>
                                        <img src={authUser.photoURL} className="w-16 h-16 rounded-full mx-auto mb-4"/>
                                        <h3 className="text-xl font-bold">{authUser.displayName}</h3>
                                        <button onClick={()=>signOut(auth).then(()=>setShowLogin(false))} className="mt-4 text-red-500 font-bold">Cerrar Sesi√≥n</button>
                                        {/* Acceso Maestro Oculto (Si el mail coincide) */}
                                        <button onClick={()=>setAdminOpen(true)} className="mt-8 block mx-auto text-xs text-zinc-600">Panel Maestro</button>
                                    </>
                                ) : (
                                    <>
                                        <h3 className="text-xl font-black text-white mb-6">ACCESO</h3>
                                        <button onClick={loginGoogle} className="w-full bg-white text-black font-bold py-3 rounded-xl mb-4 flex items-center justify-center gap-2">GOOGLE LOGIN</button>
                                        <div className="border-t border-white/10 pt-4">
                                            <p className="text-xs text-zinc-500 mb-2">Administrador</p>
                                            <form onSubmit={(e)=>{e.preventDefault(); if(e.target.pass.value==='maestro2026'){setShowLogin(false); setAdminOpen(true);} else { alert('Error'); }}}><input name="pass" type="password" placeholder="Clave Maestra" className="w-full bg-black/50 border border-zinc-700 p-2 rounded text-center text-white mb-2" /><button className="w-full btn-premium py-2 rounded font-bold text-xs">ENTRAR</button></form>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    )}

                    {adminOpen && <AdminPanel onClose={()=>setAdminOpen(false)} />}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>