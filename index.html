<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soy Tom√© - Gana Puntos Ayudando</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: { 
                        brand: { bg: '#f3f4f6', card: '#ffffff', accent: '#6366f1', dark: '#1e293b' }
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background-color: #f3f4f6; color: #1e293b; margin: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .leaflet-container { width: 100%; height: 100%; z-index: 1; background: #e5e7eb; }
        
        /* Glassmorphism Light */
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .glass-dark { background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); color: white; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* PIN ESTILIZADO */
        .pin-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.2s; }
        .pin-wrapper:hover { transform: scale(1.1); z-index: 1000; }
        .pin-icon { 
            width: 40px; height: 40px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 3px solid white; 
        }
        .pin-shadow { width: 12px; height: 4px; background: rgba(0,0,0,0.3); border-radius: 50%; margin-top: 2px; filter: blur(2px); }
        
        /* POPUP MAPA */
        .leaflet-popup-content-wrapper { background: white; border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .leaflet-popup-content { margin: 0; width: auto !important; }
        .leaflet-popup-tip { background: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Siren, Shield, Flame, Dog, FileText, AlertTriangle, Plus, X, MapPin, Loader2, MessageCircle, Send, User, LogOut, Settings, Camera, Navigation, LogIn, RefreshCw, Trophy, Star } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, updateDoc, arrayUnion, setDoc, getDoc, increment } from 'firebase/firestore';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'firebase/auth';

        // --------------------------------------------------------
        // üîë PEGA TUS CREDENCIALES DE FIREBASE AQU√ç
        // --------------------------------------------------------
        const firebaseConfig = {
            apiKey: "", 
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        // INICIALIZACI√ìN
        let db, auth;
        try {
            if(firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            }
        } catch (e) { console.error("Firebase Error:", e); }

        // UTILS
        const REPORT_TYPES = [
            { id: 'accident', label: 'Accidente', icon: Siren, color: '#ef4444', gradient: 'from-red-500 to-red-600' },
            { id: 'fire', label: 'Incendio', icon: Flame, color: '#f97316', gradient: 'from-orange-500 to-orange-600' },
            { id: 'security', label: 'Seguridad', icon: Shield, color: '#3b82f6', gradient: 'from-blue-500 to-blue-600' },
            { id: 'pet', label: 'Mascota', icon: Dog, color: '#eab308', gradient: 'from-yellow-400 to-yellow-600' },
            { id: 'docs', label: 'Documentos', icon: FileText, color: '#a855f7', gradient: 'from-purple-500 to-purple-600' },
            { id: 'other', label: 'Otro', icon: AlertTriangle, color: '#64748b', gradient: 'from-gray-500 to-gray-600' },
        ];

        const compressImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new window.Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = 500 / img.width; 
                    canvas.width = 500; canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                }
            }
        });

        // --- COMPONENTE: MAPA VIBRANTE ---
        const LeafletMap = ({ reports, onMapClick, onMarkerClick, userLoc, refreshTrigger }) => {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const popupRef = useRef(null);

            useEffect(() => {
                if (!mapInstance.current && mapRef.current) {
                    const map = L.map(mapRef.current, { zoomControl: false, attributionControl: false }).setView([-36.6158, -72.9575], 14);
                    
                    // üî• MAPA COLORIDO Y R√ÅPIDO (CARTO VOYAGER)
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; CartoDB',
                        maxZoom: 20
                    }).addTo(map);

                    mapInstance.current = map;

                    map.on('click', (e) => {
                        const { lat, lng } = e.latlng;
                        if(popupRef.current) map.removeLayer(popupRef.current);

                        const popupContent = document.createElement('div');
                        popupContent.innerHTML = `
                            <button id="btn-report-here" style="background:#6366f1; color:white; font-family:'Outfit'; font-weight:700; padding:10px 20px; border-radius:12px; border:none; cursor:pointer; display:flex; align-items:center; gap:8px; box-shadow:0 4px 12px rgba(99,102,241,0.4); width:100%;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
                                REPORTAR AQU√ç
                            </button>
                        `;
                        
                        popupContent.querySelector('#btn-report-here').onclick = () => {
                            map.removeLayer(popupRef.current);
                            onMapClick({ lat, lng });
                        };

                        popupRef.current = L.popup({ closeButton: false, offset: [0, -20], minWidth: 150 })
                            .setLatLng(e.latlng)
                            .setContent(popupContent)
                            .openOn(map);
                    });
                }

                // Forzar recarga de tiles si se pide
                if(mapInstance.current) {
                    setTimeout(() => mapInstance.current.invalidateSize(), 200);
                }

                const map = mapInstance.current;
                
                // Marcadores
                if(map) {
                    map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });

                    reports.forEach(r => {
                        const type = REPORT_TYPES.find(t => t.id === r.type) || REPORT_TYPES[5];
                        const iconHtml = `
                            <div class="pin-wrapper">
                                <div class="pin-icon" style="background: ${type.color}">
                                    ${getIconSvg(r.type)}
                                </div>
                                <div class="pin-shadow"></div>
                            </div>
                        `;
                        
                        const icon = L.divIcon({ html: iconHtml, className: '', iconSize: [40, 50], iconAnchor: [20, 45] });
                        const marker = L.marker([r.lat, r.lng], { icon }).addTo(map);
                        marker.on('click', () => onMarkerClick(r));
                    });
                }

            }, [reports, userLoc, refreshTrigger]);

            // Efecto volar a usuario
            useEffect(() => {
                if(mapInstance.current && userLoc) {
                     mapInstance.current.flyTo([userLoc.lat, userLoc.lng], 16, { duration: 1 });
                }
            }, [userLoc]);

            return <div ref={mapRef} className="w-full h-full" />;
        };

        const getIconSvg = (typeId) => {
            if(typeId === 'accident') return '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>';
            return '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState({ xp: 0, level: 1 });
            const [userLoc, setUserLoc] = useState(null);
            const [reports, setReports] = useState([]);
            const [refresh, setRefresh] = useState(0);
            
            // UI States
            const [showLogin, setShowLogin] = useState(false);
            const [showCreate, setShowCreate] = useState(false);
            const [showControl, setShowControl] = useState(false);
            const [selectedReport, setSelectedReport] = useState(null);
            const [createLoc, setCreateLoc] = useState(null);

            useEffect(() => {
                // Auth Listener & XP System
                if(auth) onAuthStateChanged(auth, async (u) => {
                    setUser(u);
                    if(u) {
                        const userRef = doc(db, 'users', u.uid);
                        const docSnap = await getDoc(userRef);
                        if(docSnap.exists()) {
                            setUserData(docSnap.data());
                        } else {
                            await setDoc(userRef, { xp: 0, level: 1, name: u.displayName, photo: u.photoURL });
                        }
                        // Listen for XP changes
                        onSnapshot(userRef, (d) => { if(d.exists()) setUserData(d.data()); });
                    }
                });
                
                if(db) {
                    const q = query(collection(db, 'reports'));
                    onSnapshot(q, s => setReports(s.docs.map(d=>({id:d.id, ...d.data()}))) );
                }

                locateUser();
            }, []);

            const locateUser = () => {
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        p => setUserLoc({lat: p.coords.latitude, lng: p.coords.longitude}),
                        null, { enableHighAccuracy: true }
                    );
                }
            };

            const handleRefresh = () => {
                setRefresh(prev => prev + 1);
                locateUser();
            };

            const handleGoogleLogin = async () => {
                if(!auth) return alert("Firebase no configurado.");
                try {
                    await signInWithPopup(auth, new GoogleAuthProvider());
                    setShowLogin(false);
                } catch (e) { alert("Error Auth: " + e.message); }
            };

            const handleMapClick = (loc) => {
                if(!user) return setShowLogin(true);
                setCreateLoc(loc);
                setShowCreate(true);
            };

            return (
                <div className="h-[100dvh] flex flex-col bg-brand-bg font-sans overflow-hidden relative">
                    {/* BARRA SUPERIOR FLOTANTE */}
                    <div className="absolute top-4 left-4 right-4 z-20 flex justify-between items-start pointer-events-none">
                        
                        {/* Logo & Status */}
                        <div className="flex flex-col gap-2 pointer-events-auto">
                            <div className="bg-white/90 backdrop-blur-md px-4 py-2 rounded-full shadow-xl flex items-center gap-2 border border-white">
                                <div className="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse"></div>
                                <h1 className="font-black tracking-tighter text-lg text-brand-dark">SOY TOM√â</h1>
                            </div>
                            
                            {user && (
                                <div className="bg-brand-dark/90 backdrop-blur-md px-4 py-2 rounded-full shadow-xl flex items-center gap-3 text-white border border-white/10">
                                    <div className="relative">
                                        <img src={user.photoURL} className="w-8 h-8 rounded-full border-2 border-brand-accent" />
                                        <div className="absolute -bottom-1 -right-1 bg-brand-accent text-[10px] font-black w-4 h-4 flex items-center justify-center rounded-full">
                                            {Math.floor(userData.xp / 100) + 1}
                                        </div>
                                    </div>
                                    <div>
                                        <p className="text-xs font-bold leading-none text-brand-accent">XP {userData.xp}</p>
                                        <p className="text-[10px] text-gray-400 font-medium">Nivel {Math.floor(userData.xp / 100) + 1}</p>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Botones de Acci√≥n */}
                        <div className="flex gap-2 pointer-events-auto">
                            <button onClick={handleRefresh} className="w-10 h-10 rounded-full bg-white text-brand-dark flex items-center justify-center shadow-lg border border-white hover:bg-gray-50 active:scale-90 transition">
                                <RefreshCw size={18} />
                            </button>
                            
                            {user ? (
                                <button onClick={()=>setUserLoc({...userLoc})} className="w-10 h-10 rounded-full bg-brand-accent text-white flex items-center justify-center shadow-lg hover:brightness-110 active:scale-90 transition">
                                    <Navigation size={18}/>
                                </button>
                            ) : (
                                <button onClick={()=>setShowLogin(true)} className="bg-brand-dark text-white px-5 py-2.5 rounded-full font-bold text-sm shadow-xl flex items-center gap-2 hover:scale-105 transition">
                                    <LogIn size={16}/> ENTRAR
                                </button>
                            )}
                        </div>
                    </div>

                    {/* MAPA */}
                    <div className="flex-1 relative z-0">
                        <LeafletMap 
                            reports={reports} 
                            userLoc={userLoc} 
                            refreshTrigger={refresh}
                            onMapClick={handleMapClick}
                            onMarkerClick={setSelectedReport}
                        />
                    </div>

                    {/* MODAL CREAR REPORTE */}
                    {showCreate && createLoc && (
                        <CreateReportModal 
                            lat={createLoc.lat} 
                            lng={createLoc.lng} 
                            user={user} 
                            onClose={()=>setShowCreate(false)}
                            db={db}
                        />
                    )}

                    {/* MODAL LOGIN */}
                    {showLogin && (
                        <div className="fixed inset-0 z-[100] bg-brand-dark/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                                <div className="bg-brand-accent/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Trophy className="text-brand-accent" size={32} />
                                </div>
                                <h2 className="text-3xl font-black text-brand-dark mb-2">Sube de Nivel</h2>
                                <p className="text-gray-500 mb-8 text-sm">Gana puntos reportando incidencias y ayudando a tu comunidad.</p>
                                
                                <button onClick={handleGoogleLogin} className="w-full bg-brand-dark text-white py-4 rounded-xl font-bold flex items-center justify-center gap-3 hover:scale-105 transition shadow-lg">
                                    <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27 3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12c0 5.05 4.13 10 10.22 10 5.35 0 9.25-3.67 9.25-9.09 0-1.15-.15-1.81-.15-1.81z"/></svg>
                                    Entrar con Google
                                </button>
                                <button onClick={()=>setShowLogin(false)} className="mt-4 text-gray-400 text-xs font-bold hover:text-brand-dark">CANCELAR</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- SUBCOMPONENTES ---
        const CreateReportModal = ({ lat, lng, user, onClose, db }) => {
            const [data, setData] = useState({ type: 'security', desc: '', src: [] });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async () => {
                if(!data.desc) return alert("Falta descripci√≥n");
                setLoading(true);
                
                // 1. Crear Reporte
                const report = {
                    ...data, lat, lng,
                    userId: user.uid,
                    userNick: user.displayName,
                    userPhoto: user.photoURL,
                    date: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),
                    timestamp: Date.now(),
                    comments: []
                };
                
                if(db) {
                    await addDoc(collection(db, 'reports'), report);
                    // 2. Dar XP al usuario
                    const userRef = doc(db, 'users', user.uid);
                    await updateDoc(userRef, { xp: increment(50) });
                    
                    // Efecto Confeti
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    alert("¬°Reporte enviado! +50 XP üåü");
                }
                
                setLoading(false);
                onClose();
            };

            const handleFile = async (e) => {
                if(e.target.files[0]) {
                    const b64 = await compressImage(e.target.files[0]);
                    setData({...data, src: [b64]});
                }
            };

            return (
                <div className="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-4">
                    <div className="bg-white w-full max-w-lg sm:rounded-3xl rounded-t-3xl p-6 animate-float shadow-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 bg-gray-100 p-2 rounded-full hover:bg-gray-200"><X size={20}/></button>
                        <h3 className="text-2xl font-black text-brand-dark mb-6">Nuevo Reporte</h3>
                        
                        <div className="grid grid-cols-3 gap-3 mb-6">
                            {REPORT_TYPES.map(t => (
                                <button key={t.id} onClick={()=>setData({...data, type:t.id})}
                                    className={`p-3 rounded-2xl border-2 flex flex-col items-center gap-1 transition ${data.type===t.id ? 'bg-brand-accent/10 border-brand-accent text-brand-accent' : 'border-gray-100 text-gray-400 hover:bg-gray-50'}`}>
                                    <t.icon size={24}/>
                                    <span className="text-[10px] font-bold uppercase">{t.label}</span>
                                </button>
                            ))}
                        </div>

                        <textarea value={data.desc} onChange={e=>setData({...data, desc:e.target.value})} 
                            className="w-full bg-gray-50 p-4 rounded-2xl border-2 border-transparent focus:border-brand-accent focus:bg-white outline-none mb-4 text-brand-dark transition" 
                            placeholder="¬øQu√© est√° pasando?" rows="3"></textarea>
                        
                        <div className="flex gap-3">
                            <label className="bg-gray-100 p-4 rounded-2xl cursor-pointer hover:bg-gray-200 transition text-gray-500">
                                <input type="file" className="hidden" onChange={handleFile}/>
                                <Camera className={data.src[0] ? 'text-green-500' : ''}/>
                            </label>
                            <button onClick={handleSubmit} disabled={loading} className="flex-1 bg-brand-accent text-white font-black rounded-2xl text-lg hover:scale-105 transition shadow-lg shadow-brand-accent/30">
                                {loading ? 'Enviando...' : 'GANAR +50 XP'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>