<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soy Tom茅 - Red de Emergencia en Vivo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Playfair Display', 'serif'] },
                    colors: { 
                        gold: { 300: '#fde047', 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706', 700: '#b45309', 800: '#92400e' }, 
                        whatsapp: '#25D366',
                        brand: { bg: '#050505', card: '#1a1a1a', accent: '#6366f1' },
                        crisis: { red: '#ef4444', green: '#10b981', alert: '#f59e0b' }
                    },
                    animation: {
                        'liquid-gold': 'liquid 15s ease infinite',
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'vibrate': 'vibrate 0.3s linear infinite',
                        'blink-random': 'blinkRandom 4s infinite',
                        'spin-slow': 'spin 4s linear infinite',
                        'float': 'float 6s ease-in-out infinite'
                    },
                    keyframes: {
                        liquid: { '0%': { backgroundPosition: '0% 50%' }, '50%': { backgroundPosition: '100% 50%' }, '100%': { backgroundPosition: '0% 50%' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        pulseGlow: { '0%, 100%': { boxShadow: '0 0 15px rgba(245, 158, 11, 0.3)' }, '50%': { boxShadow: '0 0 30px rgba(245, 158, 11, 0.7)' } },
                        vibrate: { '0%': { transform: 'translate(0)' }, '20%': { transform: 'translate(-1px, 1px)' }, '40%': { transform: 'translate(-1px, -1px)' }, '60%': { transform: 'translate(1px, 1px)' }, '80%': { transform: 'translate(1px, -1px)' } },
                        blinkRandom: { '0%, 90%, 100%': { height: '0' }, '95%': { height: '100%' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        spin: { from: { transform: 'rotate(0deg)' }, to: { transform: 'rotate(360deg)' } }
                    }
                }
            }
        }
    </script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #050505; color: #fff; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        .system-sleeping { filter: grayscale(100%) brightness(0.6) contrast(1.1); transition: filter 1.5s ease; cursor: pointer; }
        .system-awake { filter: grayscale(0%) brightness(1); transition: filter 0.8s ease; }
        
        .bg-liquid-gold {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(-45deg, #0f0f0f, #1a1a1a, #271a00, #451a03);
            background-size: 400% 400%;
            animation: liquid-gold 15s ease infinite;
        }

        .glass-dark { background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-gold { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(245, 158, 11, 0.15); }
        .diadema { background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(25px); border-bottom: 1px solid rgba(251, 191, 36, 0.2); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.8); }
        .btn-premium { background: linear-gradient(135deg, #b45309, #f59e0b); color: black; box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); border: 1px solid #fcd34d; }
        
        /* Map Styles */
        .leaflet-container { width: 100%; height: 100%; background: #e5e7eb; z-index: 0; }
        .pin-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.2s; }
        .pin-wrapper:hover { transform: scale(1.1); z-index: 1000; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Settings, ShoppingBag, Music, Home, Menu, X, Plus, Trash2, Edit3, Image, Lock, Play, Pause, SkipForward, SkipBack, Share2, MapPin, DollarSign, Loader2, ShoppingCart, User, ArrowLeft, Siren, Shield, Flame, Dog, FileText, AlertTriangle, RefreshCw, Navigation, LogIn, LogOut } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy } from 'firebase/firestore';
        import { getAuth, signInAnonymously } from 'firebase/auth';

        // =================================================================================
        // 1. CONFIGURACIN DE FIREBASE (INTEGRADO - SOY TOM)
        // ---------------------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyCYQHWlpWXqxYj8Lk7gLAQT3c2_YaFs8Ew",
            authDomain: "soy-tome.firebaseapp.com",
            projectId: "soy-tome",
            storageBucket: "soy-tome.firebasestorage.app",
            messagingSenderId: "381653906684",
            appId: "1:381653906684:web:1c0a213ab4364fbed81379",
            measurementId: "G-6YGWLM475M"
        };
        // =================================================================================

        // 2. INICIALIZACIN DE APP (FIREBASE LIVE DATA)
        let db = null;
        let auth = null;
        
        try {
            // Verificar si la configuraci贸n es v谩lida (ya no es un placeholder)
            if (firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("TU_API_KEY")) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                signInAnonymously(auth).catch(e => console.error("Auth Anon Error:", e));
                console.log(" Firebase conectado exitosamente");
            } else {
                console.warn("锔 MODO OFFLINE: Configura Firebase correctamente.");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // --- UTILS ---
        const REPORT_TYPES = [
            { id: 'accident', label: 'Accidente', icon: Siren, color: '#ef4444' },
            { id: 'fire', label: 'Incendio', icon: Flame, color: '#f97316' },
            { id: 'security', label: 'Seguridad', icon: Shield, color: '#3b82f6' },
            { id: 'pet', label: 'Mascota', icon: Dog, color: '#eab308' },
            { id: 'other', label: 'Otro', icon: AlertTriangle, color: '#64748b' },
        ];

        // --- COMPONENTES VISUALES ---

        const LeafletMap = ({ reports, onMapClick, onMarkerClick, userLoc }) => {
            const mapContainer = useRef(null);
            const mapInstance = useRef(null);
            
            useEffect(() => {
                if (!mapInstance.current && mapContainer.current) {
                    const map = L.map(mapContainer.current, { zoomControl: false, attributionControl: false }).setView([-36.6158, -72.9575], 14);
                    // Esri World Topo (Professional & Vivid)
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri',
                        maxZoom: 19
                    }).addTo(map);

                    mapInstance.current = map;
                    map.on('click', (e) => onMapClick(e.latlng));
                    setTimeout(() => map.invalidateSize(), 200);
                }

                const map = mapInstance.current;
                if(map) {
                    // Limpieza y Renderizado de Pines
                    map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
                    
                    reports.forEach(r => {
                        const type = REPORT_TYPES.find(t => t.id === r.type) || REPORT_TYPES[4];
                        const iconHtml = `<div style="display:flex; flex-direction:column; align-items:center;">
                            <div style="width:40px; height:40px; border-radius:50%; background:${type.color}; display:flex; align-items:center; justify-content:center; border:2px solid white; box-shadow:0 4px 10px rgba(0,0,0,0.5);">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                </svg>
                            </div>
                        </div>`;
                        const icon = L.divIcon({ html: iconHtml, className: '', iconSize: [40, 40], iconAnchor: [20, 20] });
                        const marker = L.marker([r.lat, r.lng], { icon }).addTo(map);
                        marker.on('click', () => onMarkerClick(r));
                    });
                }
            }, [reports]);

            useEffect(() => {
                if(mapInstance.current && userLoc) mapInstance.current.flyTo([userLoc.lat, userLoc.lng], 16, { duration: 1.5 });
            }, [userLoc]);

            return <div ref={mapContainer} className="w-full h-full" />;
        };

        // --- COMPONENTE: MODAL DE REPORTE (REFACTORIZADO PARA FIREBASE) ---
        const CreateReportModal = ({ lat, lng, onClose }) => {
            const [data, setData] = useState({ type: 'security', desc: '', contact: '' });
            const [loading, setLoading] = useState(false);

            // 3. REFACTOR: SUBMIT REPORT
            const handleSubmit = async () => {
                if(!data.desc) return alert("Falta descripci贸n");
                
                setLoading(true);
                
                const newReport = {
                    ...data,
                    lat, 
                    lng,
                    timestamp: Date.now(),
                    dateString: new Date().toLocaleTimeString(),
                    status: 'active'
                };

                try {
                    if (db) {
                        // Push to Firebase 'reports' collection
                        await addDoc(collection(db, 'reports'), newReport);
                        alert("隆Reporte enviado a la red en vivo!");
                    } else {
                        // Fallback si no hay config
                        console.warn("Guardando localmente (Sin Firebase)");
                        const local = JSON.parse(localStorage.getItem('st_reports') || '[]');
                        localStorage.setItem('st_reports', JSON.stringify([newReport, ...local]));
                        alert("Reporte guardado (Modo Offline)");
                    }
                    onClose();
                } catch (error) {
                    console.error("Error subiendo reporte:", error);
                    alert("Error al enviar reporte: " + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-4">
                    <div className="bg-zinc-900 w-full max-w-lg sm:rounded-3xl rounded-t-3xl p-6 shadow-2xl relative border-t border-gold-500/30">
                        <button onClick={onClose} className="absolute top-4 right-4 text-zinc-500"><X size={20}/></button>
                        <h3 className="text-xl font-black text-white mb-6">NUEVO REPORTE</h3>
                        
                        <div className="grid grid-cols-3 gap-3 mb-6">
                            {REPORT_TYPES.map(t => (
                                <button key={t.id} onClick={()=>setData({...data, type:t.id})}
                                    className={`p-3 rounded-xl border flex flex-col items-center gap-1 transition ${data.type===t.id ? 'bg-gold-500/20 border-gold-500 text-gold-500' : 'border-zinc-800 text-zinc-500'}`}>
                                    <t.icon size={20}/>
                                    <span className="text-[9px] font-bold uppercase">{t.label}</span>
                                </button>
                            ))}
                        </div>
                        
                        <textarea value={data.desc} onChange={e=>setData({...data, desc:e.target.value})} 
                            className="w-full bg-black border border-zinc-700 p-4 rounded-xl text-white mb-4 h-24" 
                            placeholder="Describe el incidente..."></textarea>

                        <button onClick={handleSubmit} disabled={loading} className="w-full bg-gold-500 text-black font-black rounded-xl py-4 hover:scale-105 transition shadow-lg">
                            {loading ? 'ENVIANDO...' : 'PUBLICAR ALERTA'}
                        </button>
                    </div>
                </div>
            );
        };

        const ReportDetailModal = ({ report, onClose, isAdmin, onDelete }) => {
            if(!report) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-md" onClick={onClose}></div>
                    <div className="relative w-full max-w-md bg-zinc-900 rounded-2xl border border-white/10 p-6 animate-fade-in">
                        <button onClick={onClose} className="absolute top-4 right-4 text-white"><X/></button>
                        <h3 className="text-2xl font-black text-white mb-2">{REPORT_TYPES.find(t=>t.id===report.type)?.label || 'Reporte'}</h3>
                        <p className="text-zinc-300 mb-4">{report.desc}</p>
                        <div className="text-xs text-zinc-500 mb-6">{report.dateString}</div>
                        {isAdmin && (
                            <button onClick={()=>onDelete(report.id)} className="w-full py-3 bg-red-600 text-white font-bold rounded-xl flex items-center justify-center gap-2">
                                <Trash2 size={16}/> ELIMINAR (ADMIN)
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [view, setView] = useState('home');
            const [userLoc, setUserLoc] = useState(null);
            
            // 4. REFACTOR: LOAD REPORTS (REAL-TIME LISTENER)
            const [reports, setReports] = useState([]);
            
            useEffect(() => {
                if (db) {
                    // Escuchar colecci贸n 'reports' en tiempo real
                    const q = query(collection(db, 'reports')); // Se puede agregar orderBy('timestamp', 'desc')
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const liveData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setReports(liveData);
                    }, (error) => {
                        console.error("Error reading reports:", error);
                    });
                    return () => unsubscribe();
                } else {
                    // Fallback local si no hay Firebase configurado
                    const local = JSON.parse(localStorage.getItem('st_reports') || '[]');
                    setReports(local);
                }
            }, []);

            // Estado Admin (Local)
            const [isAdmin, setIsAdmin] = useState(() => sessionStorage.getItem('st_admin') === 'true');
            const [selectedReport, setSelectedReport] = useState(null);
            const [createLoc, setCreateLoc] = useState(null);
            const [showCreate, setShowCreate] = useState(false);
            const [awake, setAwake] = useState(false);

            useEffect(() => {
                if(view === 'map' && navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(p => setUserLoc({lat: p.coords.latitude, lng: p.coords.longitude}));
                }
            }, [view]);

            // 5. ADMIN LOGIC: DELETE FROM FIREBASE
            const deleteReport = async (id) => {
                if(!confirm("驴Eliminar reporte permanentemente?")) return;
                
                try {
                    if (db) {
                        await deleteDoc(doc(db, 'reports', id));
                    } else {
                        // Local deletion fallback
                        const updated = reports.filter(r => r.id !== id);
                        setReports(updated);
                        localStorage.setItem('st_reports', JSON.stringify(updated));
                    }
                    setSelectedReport(null);
                } catch (e) {
                    alert("Error eliminando: " + e.message);
                }
            };

            const toggleAdmin = () => {
                if (isAdmin) {
                    setIsAdmin(false);
                    sessionStorage.removeItem('st_admin');
                } else {
                    const p = prompt("Admin Key:");
                    if (p === 'soytome123') {
                        setIsAdmin(true);
                        sessionStorage.setItem('st_admin', 'true');
                        alert("Modo Admin Activado");
                    }
                }
            };

            return (
                <div className={`min-h-screen font-sans text-white ${awake?'':'grayscale'}`} onClick={()=>setAwake(true)}>
                    <div className="bg-liquid-gold fixed inset-0 z-[-1] animate-liquid-gold"></div>

                    {view === 'home' && (
                        <div className="h-screen flex flex-col items-center justify-center p-6 text-center">
                            <h1 className="text-5xl font-black mb-8 text-white">SOY TOM</h1>
                            <button onClick={()=>setView('map')} className="bg-white text-black px-8 py-4 rounded-full font-black shadow-lg hover:scale-105 transition flex items-center gap-2">
                                <MapPin/> VER MAPA EN VIVO
                            </button>
                        </div>
                    )}

                    {view === 'map' && (
                        <div className="absolute inset-0">
                            <LeafletMap 
                                reports={reports} 
                                userLoc={userLoc} 
                                onMapClick={(latlng) => { setCreateLoc(latlng); setShowCreate(true); }}
                                onMarkerClick={setSelectedReport}
                            />
                            
                            {/* Botones Flotantes */}
                            <button onClick={()=>setView('home')} className="fixed bottom-6 left-6 z-[1000] bg-zinc-900 p-3 rounded-full shadow-lg"><ArrowLeft/></button>
                            <button onClick={toggleAdmin} className={`fixed bottom-6 left-20 z-[1000] p-3 rounded-full shadow-lg ${isAdmin ? 'bg-red-600' : 'bg-zinc-900 opacity-50'}`}><Settings size={20}/></button>
                            
                            <button onClick={()=>{ if(userLoc) { setCreateLoc(userLoc); setShowCreate(true); } else alert("Obteniendo ubicaci贸n..."); }} className="fixed bottom-6 right-6 z-[1000] bg-gold-500 text-black px-6 py-4 rounded-full shadow-xl font-bold flex items-center gap-2 animate-pulse">
                                <Plus/> REPORTAR
                            </button>
                        </div>
                    )}

                    {showCreate && createLoc && <CreateReportModal lat={createLoc.lat} lng={createLoc.lng} onClose={()=>setShowCreate(false)} db={db}/>}
                    <ReportDetailModal report={selectedReport} onClose={()=>setSelectedReport(null)} isAdmin={isAdmin} onDelete={deleteReport} />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>