
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Soy Tomé - MasterHub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 
                        gold: '#fbbf24', 
                        brand: { bg: '#09090b', card: '#18181b', border: '#27272a' },
                    },
                    animation: {
                        'liquid': 'liquid 20s ease infinite',
                    },
                    keyframes: {
                        liquid: { '0%': { backgroundPosition: '0% 50%' }, '50%': { backgroundPosition: '100% 50%' }, '100%': { backgroundPosition: '0% 50%' } }
                    }
                }
            }
        }
    </script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #050505; color: #fff; margin: 0; user-select: none; -webkit-tap-highlight-color: transparent; height: 100dvh; overflow: hidden; }
        .leaflet-container { width: 100%; height: 100%; z-index: 0; background: #f0f0f0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .liquid-glass-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background: linear-gradient(-45deg, #000000, #3d2b00, #6b4e00, #000000); background-size: 300% 300%; animation: liquid 15s ease infinite; }
        .glass-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; backdrop-filter: blur(20px); background: rgba(0,0,0,0.4); }
        .user-pulse { animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .vertical-text { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); }
        .eye-container { width: 160px; height: 90px; background: #e5e5e5; border-radius: 50% 50% 50% 50% / 70% 70% 40% 40%; position: relative; overflow: hidden; box-shadow: 0 0 40px rgba(251, 191, 36, 0.3); border-top: 4px solid #000; }
        .eye-pupil { width: 45px; height: 45px; background: #09090b; border-radius: 50%; position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); transition: transform 0.08s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { MapPin, Plus, X, Siren, Shield, Flame, Dog, AlertTriangle, Heart, Zap, Camera, Navigation, Star, Phone, User, Layers, Eye, EyeOff, MessageCircle, Send, Settings, Trash2, Cloud, Sun, CloudRain, Facebook, Instagram, Youtube, Hash, Save, ArrowLeft, ShoppingBag, Utensils, Sparkles, PartyPopper, Wrench, Pill, Fuel, Hammer, Search, Shirt, Apple, Package, Lightbulb, Briefcase, Home, Key, Pencil, Bath } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, setDoc, getDoc } from 'firebase/firestore';
        import { getAuth, signInAnonymously } from 'firebase/auth';

        const firebaseConfig = {
            apiKey: "AIzaSyCYQHWlpWXqxYj8Lk7gLAQT3c2_YaFs8Ew",
            authDomain: "soy-tome.firebaseapp.com",
            projectId: "soy-tome",
            storageBucket: "soy-tome.firebasestorage.app",
            messagingSenderId: "381653906684",
            appId: "1:381653906684:web:1c0a213ab4364fbed81379",
            measurementId: "G-6YGWLM475M"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        signInAnonymously(getAuth(app)).catch(console.error);

        const ICONS_SVG = {
            siren: '<path d="M7 18v-6a5 5 0 1 1 10 0v6"/><path d="M5 21a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2"/><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8"/><path d="M3 11.5a8.38 8.38 0 0 0 .9 3.8"/>',
            heart: '<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>',
            shield: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>',
            toilet: '<path d="M9 12h6m-6 4h6m2 5v-7a3 3 0 0 0-3-3H10a3 3 0 0 0-3 3v7"/><path d="M6 12V5a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v7"/>'
        };

        const REPORT_TYPES = [
            { id: 'sos_help', label: 'NECESITO AYUDA', icon: Siren, color: '#ef4444', svg: ICONS_SVG.siren },
            { id: 'sos_offer', label: 'OFREZCO AYUDA', icon: Heart, color: '#10b981', svg: ICONS_SVG.heart },
            { id: 'restroom', label: 'Baño', icon: Bath, color: '#a16207', svg: ICONS_SVG.toilet },
            { id: 'food', label: 'Fast Food', icon: Utensils, color: '#eab308' },
            { id: 'cabins', label: 'Cabañas', icon: Home, color: '#d97706' },
            { id: 'rent', label: 'Arriendos', icon: Key, color: '#4f46e5' },
            { id: 'market', label: 'Emprendimiento', icon: ShoppingBag, color: '#8b5cf6' },
            { id: 'services', label: 'Servicios', icon: Briefcase, color: '#6366f1' },
            { id: 'data', label: 'Dato Útil', icon: Lightbulb, color: '#14b8a6' },
        ];

        const LeafletMap = ({ reports, onMapClick, onMarkerClick, userLoc, styleMode, filter }) => {
            const mapContainer = useRef(null);
            const mapInstance = useRef(null);
            const tileLayerRef = useRef(null);
            const userMarkerRef = useRef(null);

            const MAP_STYLES = {
                urban: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', // CLARO MINIMALISTA (Voyager)
                satellite: 'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', 
                light: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', // EXTRA LIMPIO (Positron)
                dark: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' // NEGRO PREMIUM
            };

            useEffect(() => {
                if (!mapInstance.current && mapContainer.current) {
                    const center = userLoc ? [userLoc.lat, userLoc.lng] : [-36.6158, -72.9575];
                    const map = L.map(mapContainer.current, { zoomControl: false }).setView(center, 14);
                    tileLayerRef.current = L.tileLayer(MAP_STYLES[styleMode], { maxZoom: 19 }).addTo(map);
                    mapInstance.current = map;
                    map.on('click', (e) => onMapClick(e.latlng));
                }
            }, []);

            useEffect(() => { if(mapInstance.current && tileLayerRef.current) tileLayerRef.current.setUrl(MAP_STYLES[styleMode]); }, [styleMode]);

            useEffect(() => {
                const map = mapInstance.current;
                if(!map) return;
                map.eachLayer(l => { if(l instanceof L.Marker && l !== userMarkerRef.current) map.removeLayer(l); });

                if(userLoc) {
                    if(userMarkerRef.current) map.removeLayer(userMarkerRef.current);
                    const userIcon = L.divIcon({ html: `<div class="user-pulse w-6 h-6 flex items-center justify-center"><div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-lg"></div></div>`, className: '', iconSize: [24, 24] });
                    userMarkerRef.current = L.marker([userLoc.lat, userLoc.lng], { icon: userIcon, zIndexOffset: 1000 }).addTo(map);
                }

                const visibleReports = filter === 'all' ? reports : reports.filter(r => r.type === filter);
                visibleReports.forEach(r => {
                    const type = REPORT_TYPES.find(t => t.id === r.type) || REPORT_TYPES[0];
                    const iconHtml = `<div style="background:${type.color};" class="w-10 h-10 rounded-full flex items-center justify-center border-2 border-white shadow-xl scale-90 hover:scale-105 transition-transform"><MapPin size={18} color="white"/></div>`;
                    L.marker([r.lat, r.lng], { icon: L.divIcon({ html: iconHtml, className: '', iconSize: [40, 40] }) }).addTo(map).on('click', () => onMarkerClick(r));
                });
            }, [reports, userLoc, filter]);

            return <div ref={mapContainer} className="w-full h-full" />;
        };

        const App = () => {
            const [view, setView] = useState('home');
            const [awake, setAwake] = useState(false);
            const [userLoc, setUserLoc] = useState(null);
            const [reports, setReports] = useState([]);
            const [showCreate, setShowCreate] = useState(false);
            const [createLoc, setCreateLoc] = useState(null);
            const [selectedReport, setSelectedReport] = useState(null);
            const [mapStyle, setMapStyle] = useState('urban'); // EMPIEZA EN ESTILO URBANO CLARO
            const [filter, setFilter] = useState('all');

            useEffect(() => {
                const q = query(collection(db, 'reports'), orderBy('timestamp', 'desc'));
                onSnapshot(q, (snap) => setReports(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            }, []);

            const enableGPS = () => {
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((p) => setUserLoc({lat: p.coords.latitude, lng: p.coords.longitude}));
                    setView('map');
                } else { setView('map'); }
            };

            return (
                <div className={`h-dvh font-sans text-white transition-all duration-1000 ${awake ? 'bg-zinc-950' : 'bg-black'}`} onClick={() => !awake && setAwake(true)}>
                    {awake && <div className="liquid-glass-bg"></div>}
                    {awake && <div className="glass-overlay"></div>}

                    {view === 'home' && (
                        <div className="h-full flex flex-col items-center justify-center p-6 text-center">
                            <h1 className={`text-6xl font-black mb-2 tracking-tighter ${awake ? 'text-white' : 'text-zinc-800'}`}>SOY<br/><span className={awake ? 'text-gold' : 'text-zinc-900'}>TOMÉ</span></h1>
                            <p className="text-zinc-500 mb-8 font-medium">Red de Emergencia Ciudadana</p>
                            {awake && (
                                <button onClick={(e) => { e.stopPropagation(); enableGPS(); }} className="bg-gold text-black px-10 py-5 rounded-full font-black shadow-[0_0_40px_rgba(245,158,11,0.5)] hover:scale-105 transition flex items-center gap-3"><Navigation fill="black"/> INGRESAR</button>
                            )}
                        </div>
                    )}

                    {view === 'map' && (
                        <div className="absolute inset-0">
                            <LeafletMap reports={reports} userLoc={userLoc} styleMode={mapStyle} filter={filter} onMapClick={(coords)=>{ setCreateLoc(coords); setShowCreate(true); }} onMarkerClick={setSelectedReport} />
                            
                            <div className="fixed top-4 left-4 right-4 z-[500] flex gap-2 overflow-x-auto no-scrollbar pb-2 pointer-events-auto">
                                <button onClick={()=>setFilter('all')} className={`flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border backdrop-blur-md ${filter === 'all' ? 'bg-gold text-black border-gold' : 'bg-black/60 text-zinc-400 border-white/10'}`}>TODOS</button>
                                {REPORT_TYPES.map(t => (
                                    <button key={t.id} onClick={()=>setFilter(t.id)} className={`flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border backdrop-blur-md flex items-center gap-2 ${filter === t.id ? 'bg-white text-black' : 'bg-black/60 text-zinc-400 border-white/10'}`}>
                                        <t.icon size={12}/> {t.label}
                                    </button>
                                ))}
                            </div>

                            <div className="fixed top-20 right-4 z-[1000] flex flex-col gap-3">
                                <button onClick={()=>{ 
                                    const styles = ['urban', 'satellite', 'light', 'dark'];
                                    const next = styles[(styles.indexOf(mapStyle) + 1) % styles.length];
                                    setMapStyle(next);
                                }} className="bg-black/80 p-3 rounded-full border border-white/20 text-white shadow-xl"><Layers size={20}/></button>
                            </div>

                            <button onClick={()=>{ if(userLoc) { setCreateLoc(userLoc); setShowCreate(true); } }} className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[1000] bg-brand-card border border-gold/50 text-gold px-8 py-4 rounded-2xl shadow-2xl font-black flex items-center gap-3 hover:bg-gold hover:text-black transition-all">
                                <Plus size={24}/> REPORTAR
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
