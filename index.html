<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Soy Tomé - MasterHub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 
                        gold: '#fbbf24', 
                        brand: { bg: '#09090b', card: '#18181b', border: '#27272a' },
                    },
                    animation: {
                        'liquid': 'liquid 20s ease infinite',
                        'eye-open': 'eyeOpen 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards',
                    },
                    keyframes: {
                        liquid: { '0%': { backgroundPosition: '0% 50%' }, '50%': { backgroundPosition: '100% 50%' }, '100%': { backgroundPosition: '0% 50%' } },
                        eyeOpen: { '0%': { transform: 'scaleY(0.1)' }, '100%': { transform: 'scaleY(1)' } }
                    }
                }
            }
        }
    </script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #050505; color: #fff; margin: 0; user-select: none; -webkit-tap-highlight-color: transparent; height: 100dvh; overflow: hidden; }
        .leaflet-container { width: 100%; height: 100%; z-index: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .liquid-glass-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background: linear-gradient(-45deg, #000000, #3d2b00, #6b4e00, #000000); background-size: 300% 300%; animation: liquid 15s ease infinite; }
        .glass-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; backdrop-filter: blur(20px); background: rgba(0,0,0,0.4); box-shadow: inset 0 0 100px rgba(0,0,0,0.8); }
        .user-pulse { animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .z-highest { z-index: 9999; }
        .eye-container { width: 160px; height: 90px; background: #e5e5e5; border-radius: 50% 50% 50% 50% / 70% 70% 40% 40%; position: relative; overflow: hidden; box-shadow: 0 0 40px rgba(251, 191, 36, 0.3); border-top: 4px solid #000; }
        .eye-pupil { width: 45px; height: 45px; background: #09090b; border-radius: 50%; position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); transition: transform 0.08s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { MapPin, Plus, X, Siren, Shield, Flame, Dog, AlertTriangle, Heart, Zap, Camera, Navigation, Star, Phone, User, Layers, Eye, EyeOff, MessageCircle, Send, Settings, Trash2, Cloud, Sun, CloudRain, Facebook, Instagram, Youtube, Hash, Save, ArrowLeft, ShoppingBag, Utensils, Sparkles, PartyPopper, Wrench, Pill, Fuel, Hammer, Search, Shirt, Apple, Package, Lightbulb, Briefcase, Home, Key, Pencil, Bath, Music } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, setDoc, getDoc } from 'firebase/firestore';
        import { getAuth, signInAnonymously } from 'firebase/auth';

        const firebaseConfig = {
            apiKey: "AIzaSyCYQHWlpWXqxYj8Lk7gLAQT3c2_YaFs8Ew",
            authDomain: "soy-tome.firebaseapp.com",
            projectId: "soy-tome",
            storageBucket: "soy-tome.firebasestorage.app",
            messagingSenderId: "381653906684",
            appId: "1:381653906684:web:1c0a213ab4364fbed81379",
            measurementId: "G-6YGWLM475M"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        signInAnonymously(auth).catch(console.error);

        const ICONS_SVG = {
            siren: '<path d="M7 18v-6a5 5 0 1 1 10 0v6"/><path d="M5 21a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2"/><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8"/><path d="M3 11.5a8.38 8.38 0 0 0 .9 3.8"/>',
            heart: '<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>',
            alert: '<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>',
            shield: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>',
            flame: '<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.4 1-2.7 2-4 .5.3 1 .8 1 1.8z"/>',
            toilet: '<path d="M9 12h6m-6 4h6m2 5v-7a3 3 0 0 0-3-3H10a3 3 0 0 0-3 3v7"/><path d="M6 12V5a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v7"/>'
        };

        const REPORT_TYPES = [
            { id: 'sos_help', label: 'NECESITO AYUDA', icon: Siren, color: '#ef4444', svg: ICONS_SVG.siren },
            { id: 'sos_offer', label: 'OFREZCO AYUDA', icon: Heart, color: '#10b981', svg: ICONS_SVG.heart },
            { id: 'restroom', label: 'Baño', icon: Bath, color: '#a16207', svg: ICONS_SVG.toilet },
            { id: 'food', label: 'Fast Food', icon: Utensils, color: '#eab308', svg: ICONS_SVG.food },
            { id: 'cabins', label: 'Cabañas', icon: Home, color: '#d97706', svg: ICONS_SVG.home },
            { id: 'rent', label: 'Arriendos', icon: Key, color: '#4f46e5', svg: ICONS_SVG.key },
            { id: 'market', label: 'Emprendimiento', icon: ShoppingBag, color: '#8b5cf6', svg: ICONS_SVG.shop },
            { id: 'services', label: 'Servicios', icon: Briefcase, color: '#6366f1', svg: ICONS_SVG.briefcase },
            { id: 'data', label: 'Dato Útil', icon: Lightbulb, color: '#14b8a6', svg: ICONS_SVG.lightbulb },
            { id: 'beauty', label: 'Belleza', icon: Sparkles, color: '#ec4899', svg: ICONS_SVG.beauty },
            { id: 'event', label: 'Eventos', icon: PartyPopper, color: '#d946ef', svg: ICONS_SVG.event },
            { id: 'vulcan', label: 'Vulcanización', icon: Wrench, color: '#64748b', svg: ICONS_SVG.wrench },
            { id: 'gas', label: 'Bencinera', icon: Fuel, color: '#be123c', svg: ICONS_SVG.fuel },
            { id: 'pharma', label: 'Farmacia', icon: Pill, color: '#0ea5e9', svg: ICONS_SVG.pill },
            { id: 'hardware', label: 'Ferretería', icon: Hammer, color: '#854d0e', svg: ICONS_SVG.hammer },
            { id: 'accident', label: 'Accidente', icon: AlertTriangle, color: '#f59e0b', svg: ICONS_SVG.alert },
            { id: 'security', label: 'Seguridad', icon: Shield, color: '#3b82f6', svg: ICONS_SVG.shield },
            { id: 'fire', label: 'Incendio', icon: Flame, color: '#f97316', svg: ICONS_SVG.flame },
            { id: 'pet', label: 'Mascota', icon: Dog, color: '#a8a29e', svg: ICONS_SVG.dog },
        ];

        const processImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 600;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
                reader.onerror = e => reject(e);
            });
        };

        const BadBunnyEye = ({ awake }) => {
            const [pupilPos, setPupilPos] = useState({ x: 0, y: 0 });
            useEffect(() => {
                const handleMove = (e) => {
                    if (!awake) return;
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    const moveX = Math.min(Math.max((clientX / window.innerWidth - 0.5) * 40, -15), 15);
                    const moveY = Math.min(Math.max((clientY / window.innerHeight - 0.5) * 20, -10), 10);
                    setPupilPos({ x: moveX, y: moveY });
                };
                window.addEventListener('mousemove', handleMove);
                window.addEventListener('touchmove', handleMove);
                return () => { window.removeEventListener('mousemove', handleMove); window.removeEventListener('touchmove', handleMove); };
            }, [awake]);
            if (!awake) return <div className="w-[160px] h-[30px] bg-zinc-800 rounded-full border-t-2 border-black"></div>;
            return <div className="eye-container"><div className="eye-pupil" style={{ transform: `translate(calc(-50% + ${pupilPos.x}px), calc(-50% + ${pupilPos.y}px))` }}></div></div>;
        };

        const WeatherWidget = () => {
            const [weather, setWeather] = useState(null);
            useEffect(() => {
                fetch('https://api.open-meteo.com/v1/forecast?latitude=-36.6158&longitude=-72.9575&current=temperature_2m,is_day,weather_code&timezone=auto')
                    .then(res => res.json()).then(data => setWeather(data.current)).catch(console.error);
            }, []);
            if (!weather) return <div className="h-10 w-24 bg-white/5 rounded-xl animate-pulse"></div>;
            let Icon = weather.weather_code > 50 ? CloudRain : (weather.weather_code > 2 ? Cloud : Sun);
            return (
                <div className="flex items-center gap-3 bg-black/60 backdrop-blur-xl px-4 py-2 rounded-2xl border border-white/10 shadow-lg pointer-events-auto">
                    <div className="text-xl font-black">{Math.round(weather.temperature_2m)}°</div>
                    <div className="h-6 w-[1px] bg-white/20"></div>
                    <Icon size={20} className="text-gold" />
                </div>
            );
        };

        const PharmacyWidget = ({ onPharmacyFound }) => {
            const [pharmacy, setPharmacy] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchP = async () => {
                    try {
                        const target = 'https://midas.minsal.cl/farmacia_v2/WS/getLocalesTurnos.php';
                        const res = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(target));
                        const data = await res.json();
                        const today = data.find(f => (f.comuna_nombre || "").toUpperCase().includes("TOME"));
                        if (today) {
                            setPharmacy(today);
                            if(onPharmacyFound) onPharmacyFound(today);
                        }
                    } catch (e) { console.error(e); } finally { setLoading(false); }
                };
                fetchP();
            }, []);

            if (loading) return <div className="h-12 w-36 bg-white/5 rounded-2xl animate-pulse"></div>;
            if (!pharmacy) return null;

            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${pharmacy.local_lat},${pharmacy.local_lng}`;

            return (
                <a href={mapsUrl} target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 bg-red-600/90 backdrop-blur-xl px-4 py-3 rounded-2xl border border-red-400/50 shadow-lg active:scale-95 transition-all pointer-events-auto">
                    <div className="text-right">
                        <div className="text-[9px] font-black uppercase text-white/80">Turno</div>
                        <div className="text-xs font-black text-white truncate max-w-[100px] uppercase">{pharmacy.local_nombre.split(' ')[0]}</div>
                    </div>
                    <div className="h-6 w-[1px] bg-white/20"></div>
                    <Pill className="text-white animate-pulse" size={20} />
                </a>
            );
        };

        const SocialIcon = ({ type, url }) => { 
            if(!url) return null; 
            const icons = { facebook: Facebook, instagram: Instagram, youtube: Youtube, threads: Hash, tiktok: Music }; 
            const Icon = icons[type] || MessageCircle; 
            return (
                <a href={url} target="_blank" rel="noopener noreferrer" className="p-3 bg-white/5 hover:bg-gold/20 hover:text-gold rounded-xl transition border border-white/5 shadow-md">
                    <Icon size={20}/>
                </a>
            ); 
        };

        const ReportDetailModal = ({ report, onClose, onDelete, isAdmin }) => {
            const typeInfo = REPORT_TYPES.find(t=>t.id===report.type) || REPORT_TYPES[0];
            return (
                <div className="fixed inset-0 flex items-end sm:items-center justify-center sm:p-4 bg-black/95 backdrop-blur-sm z-[3000]" onClick={onClose}>
                    <div className="w-full max-w-md bg-brand-card rounded-t-3xl sm:rounded-3xl border border-white/10 overflow-hidden relative max-h-[90vh] overflow-y-auto shadow-2xl no-scrollbar" onClick={e=>e.stopPropagation()}>
                        <div className="p-6"> 
                            <div className="flex justify-between items-start mb-6">
                                <div className="flex items-center gap-3">
                                    <div style={{background: typeInfo.color}} className="p-3 rounded-full text-white shadow-xl"><typeInfo.icon size={24}/></div>
                                    <div><h3 className="text-lg font-black text-white uppercase tracking-tighter">{typeInfo.label}</h3><p className="text-[10px] text-zinc-500 uppercase font-black">{report.dateString} • {report.name || 'Vecino'}</p></div>
                                </div>
                                <button onClick={onClose} className="text-zinc-500 bg-white/5 p-2.5 rounded-full"><X size={16}/></button>
                            </div>
                            
                            {/* VISUALIZADOR DE FOTOS REFORZADO (Soporta formatos antiguos y nuevos) */}
                            {report.media && report.media.length > 0 && (
                                <div className="flex overflow-x-auto gap-3 pb-4 mb-6 no-scrollbar">
                                    {report.media.map((img, idx) => {
                                        const src = typeof img === 'string' ? img : (img.url || img.base64);
                                        return src ? (
                                            <div key={idx} className="flex-shrink-0 w-72 h-72 rounded-xl overflow-hidden bg-black border border-zinc-800 shadow-xl">
                                                <img src={src} className="w-full h-full object-cover" alt="Evidencia" />
                                            </div>
                                        ) : null;
                                    })}
                                </div>
                            )}

                            {report.details?.restroomType && (
                                <div className="mb-4">
                                    <span className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase ${report.details.restroomType==='Gratis' ? 'bg-green-600' : 'bg-red-600'}`}>Baño {report.details.restroomType}</span>
                                </div>
                            )}

                            <p className="text-white text-lg leading-relaxed mb-8 font-medium">{report.desc}</p>
                            
                            {report.contact && (
                                <a href={`https://wa.me/${report.contact.replace(/\D/g,'')}`} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center gap-2 bg-green-600 text-white py-5 rounded-xl font-black text-xs uppercase tracking-widest transition active:scale-95 shadow-lg">
                                    <MessageCircle size={18}/> Contactar vía WhatsApp
                                </a>
                            )}
                            {isAdmin && <button onClick={()=>onDelete(report.id)} className="w-full bg-red-600/20 text-red-500 border border-red-500/50 py-3 rounded-xl font-black text-[10px] uppercase mt-6">Eliminar Reporte</button>}
                        </div>
                    </div>
                </div>
            );
        };

        const CreateReportModal = ({ lat, lng, onClose }) => {
            const [data, setData] = useState({ type: 'sos_help', desc: '', contact: '', name: localStorage.getItem('st_username') || '' });
            const [files, setFiles] = useState([]);
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState("PUBLICAR REPORTE");
            const [restroomType, setRestroomType] = useState("");

            const handleFileSelect = (e) => {
                const selected = Array.from(e.target.files);
                if (files.length + selected.length > 3) return alert("Máximo 3 fotos");
                setFiles([...files, ...selected]);
            };

            const handleSubmit = async () => {
                if (!data.desc) return alert("Falta descripción");
                setLoading(true);
                try {
                    const mediaUrls = [];
                    for (let i = 0; i < files.length; i++) {
                        setStatus(`Procesando foto ${i + 1}...`);
                        const base64Image = await processImage(files[i]);
                        mediaUrls.push({ url: base64Image, type: 'image' });
                    }
                    setStatus("Enviando...");
                    await addDoc(collection(db, 'reports'), { 
                        ...data, lat, lng, media: mediaUrls, timestamp: Date.now(), 
                        dateString: new Date().toLocaleTimeString(),
                        details: { restroomType: data.type === 'restroom' ? restroomType : '' }
                    });
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    onClose();
                } catch (e) { alert("Error al subir"); } finally { setLoading(false); setStatus("PUBLICAR REPORTE"); }
            };

            return (
                <div className="fixed inset-0 z-[2000] bg-black/90 backdrop-blur-md flex items-end sm:items-center justify-center pt-10 sm:p-4">
                    <div className="bg-brand-card w-full max-w-lg rounded-t-3xl sm:rounded-3xl border-t border-white/10 p-6 shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar relative">
                        <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-black text-white uppercase tracking-tighter tracking-widest">Nuevo Reporte</h3><button onClick={onClose} className="p-2 bg-white/10 rounded-full"><X size={20}/></button></div>
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            <button onClick={()=>setData({...data, type:'sos_help'})} className={`p-4 rounded-xl border-2 font-black flex flex-col items-center gap-2 ${data.type==='sos_help'?'bg-red-500/20 border-red-500 text-red-500':'border-white/10 text-zinc-500'}`}><Siren size={32}/> AYUDA</button>
                            <button onClick={()=>setData({...data, type:'sos_offer'})} className={`p-4 rounded-xl border-2 font-black flex flex-col items-center gap-2 ${data.type==='sos_offer'?'bg-green-500/20 border-green-500 text-green-500':'border-white/10 text-zinc-500'}`}><Heart size={32}/> OFRECER</button>
                        </div>
                        <div className="mb-6 overflow-x-auto no-scrollbar"><div className="flex gap-3 pb-2">{REPORT_TYPES.slice(2).map(t => (<button key={t.id} onClick={()=>setData({...data, type:t.id})} className={`flex-shrink-0 px-4 py-3 rounded-xl border text-[10px] font-black flex flex-col items-center gap-2 min-w-[90px] ${data.type===t.id?'bg-gold text-black border-gold shadow-lg':'bg-zinc-900 border-zinc-800 text-zinc-400'}`}><t.icon size={20}/> {t.label}</button>))}</div></div>
                        
                        {data.type === 'restroom' && (
                            <div className="bg-zinc-900/50 p-4 rounded-xl mb-6 border border-gold/30">
                                <p className="text-[10px] font-black text-gold mb-3 uppercase text-center tracking-widest">Tipo de Baño</p>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={()=>setRestroomType('Gratis')} className={`p-3 rounded-lg border text-xs font-black ${restroomType==='Gratis'?'bg-green-600 border-green-500':'bg-black border-zinc-700'}`}>GRATIS</button>
                                    <button onClick={()=>setRestroomType('Pago')} className={`p-3 rounded-lg border text-xs font-black ${restroomType==='Pago'?'bg-red-600 border-red-500':'bg-black border-zinc-700'}`}>PAGO ($)</button>
                                </div>
                            </div>
                        )}

                        <textarea value={data.desc} onChange={e=>setData({...data, desc:e.target.value})} className="w-full bg-black border border-zinc-800 p-5 rounded-xl text-white h-24 mb-6 outline-none focus:border-gold transition" placeholder="¿Qué está pasando exactamente?"></textarea>
                        <div className="mb-6"><label className="block w-full p-6 border-2 border-dashed border-zinc-800 rounded-xl text-center cursor-pointer text-zinc-500 hover:border-gold transition"><input type="file" multiple accept="image/*" onChange={handleFileSelect} className="hidden" /><Camera className="mx-auto mb-2"/><span className="text-[10px] font-black uppercase tracking-widest">Adjuntar Fotos Evidencia</span>{files.length > 0 && <p className="text-gold mt-2 text-xs font-black">{files.length} Seleccionadas</p>}</label></div>
                        <button onClick={handleSubmit} disabled={loading} className="w-full bg-gradient-to-r from-gold to-orange-600 text-black font-black rounded-xl py-5 shadow-2xl uppercase tracking-widest text-xs active:scale-95 transition-all">{loading ? status : 'PUBLICAR REPORTE'}</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('home');
            const [awake, setAwake] = useState(false);
            const [userLoc, setUserLoc] = useState(null);
            const [reports, setReports] = useState([]);
            const [showCreate, setShowCreate] = useState(false);
            const [createLoc, setCreateLoc] = useState(null);
            const [selectedReport, setSelectedReport] = useState(null);
            const [config, setConfig] = useState({});
            const [pharmacy, setPharmacy] = useState(null);

            useEffect(() => {
                onSnapshot(query(collection(db, 'reports'), orderBy('timestamp', 'desc')), s => setReports(s.docs.map(d => ({id: d.id, ...d.data()}))));
                onSnapshot(doc(db, 'settings', 'global'), s => { if(s.exists()) setConfig(s.data()); });
            }, []);

            const enableGPS = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(p => { setUserLoc({lat: p.coords.latitude, lng: p.coords.longitude}); setView('map'); }, () => setView('map'));
                } else setView('map');
            };

            const deleteReport = async (id) => {
                if(confirm("¿Eliminar este reporte definitivamente?")) {
                    await deleteDoc(doc(db, 'reports', id));
                    setSelectedReport(null);
                }
            };

            return (
                <div className="h-dvh font-sans text-white overflow-hidden" onClick={() => { if(!awake) setAwake(true); }}>
                    {awake && <div className="liquid-glass-bg"></div>}
                    {awake && <div className="glass-overlay"></div>}

                    {view === 'home' && (
                        <div className="h-full flex flex-col items-center justify-center p-6 text-center">
                            {!awake && <div className="absolute inset-0 bg-black z-[-1]"></div>}
                            <div className="relative z-10 mb-8"><BadBunnyEye awake={awake} /></div>
                            <h1 className="text-7xl font-black mb-2 tracking-tighter drop-shadow-2xl uppercase">Soy<br/><span className={awake ? 'text-gold' : 'text-zinc-900'}>Tomé</span></h1>
                            <p className="relative z-10 text-zinc-600 mb-10 font-black uppercase text-[9px] tracking-[0.4em] opacity-80">Red de Emergencia Ciudadana</p>
                            {awake && (
                                <div className="animate-in fade-in slide-in-from-bottom-8 flex flex-col items-center w-full max-w-sm">
                                    <button onClick={(e) => { e.stopPropagation(); enableGPS(); }} className="bg-gold text-black px-12 py-5 rounded-full font-black shadow-[0_0_50px_rgba(245,158,11,0.5)] hover:scale-105 active:scale-95 transition-all w-full mb-10 uppercase text-xs tracking-widest">Ingresar</button>
                                    <div className="mb-10 w-full flex justify-center" onClick={e=>e.stopPropagation()}><PharmacyWidget onDataLoaded={setPharmacy} /></div>
                                    <div className="flex gap-4 justify-center flex-wrap" onClick={e=>e.stopPropagation()}>
                                        {['threads', 'youtube', 'tiktok', 'instagram', 'facebook'].map(net => <SocialIcon key={net} type={net} url={config[net]} />)}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {view === 'map' && (
                        <div className="absolute inset-0">
                            <div id="map" className="w-full h-full">
                                <LeafletMap reports={reports} userLoc={userLoc} pharmacy={pharmacy} onMapClick={(c)=>{ setCreateLoc(c); setShowCreate(true); }} onMarkerClick={setSelectedReport} />
                            </div>
                            <div className="fixed top-4 left-0 right-0 z-[500] px-4 flex gap-2 pointer-events-none">
                                <div className="flex gap-2 items-center pointer-events-auto py-1">
                                    <button onClick={()=>setView('home')} className="bg-black/80 backdrop-blur-xl p-3.5 rounded-2xl border border-white/10 text-white shadow-2xl active:scale-90 transition"><ArrowLeft size={22}/></button>
                                    <WeatherWidget/>
                                    <PharmacyWidget />
                                </div>
                            </div>
                            {!showCreate && (
                                <button onClick={()=>{ if(userLoc) { setCreateLoc(userLoc); setShowCreate(true); } else enableGPS(); }} className="fixed bottom-24 left-1/2 -translate-x-1/2 z-[500] bg-brand-card border border-gold/40 text-gold px-12 py-5 rounded-2xl shadow-2xl font-black flex items-center gap-4 hover:scale-105 active:scale-95 transition-all pointer-events-auto uppercase text-xs tracking-widest"><Plus size={24}/> Reportar</button>
                            )}
                        </div>
                    )}

                    {showCreate && <CreateReportModal lat={createLoc.lat} lng={createLoc.lng} onClose={()=>setShowCreate(false)} />}
                    {selectedReport && <ReportDetailModal report={selectedReport} isAdmin={isAdmin} onDelete={deleteReport} onClose={()=>setSelectedReport(null)} />}
                </div>
            );
        };

        const LeafletMap = ({ reports, userLoc, pharmacy, onMapClick, onMarkerClick }) => {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);

            useEffect(() => {
                if (!mapInstance.current) {
                    const center = userLoc ? [userLoc.lat, userLoc.lng] : [-36.6158, -72.9575];
                    mapInstance.current = L.map('map', { zoomControl: false }).setView(center, 14);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(mapInstance.current);
                    mapInstance.current.on('click', (e) => onMapClick(e.latlng));
                }
            }, []);

            useEffect(() => {
                const map = mapInstance.current;
                if (!map) return;
                map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });

                if (userLoc) {
                    const icon = L.divIcon({ html: `<div class="user-pulse w-6 h-6 bg-blue-500 rounded-full border-2 border-white shadow-lg"></div>`, className: '', iconSize: [24, 24] });
                    L.marker([userLoc.lat, userLoc.lng], { icon, zIndexOffset: 1000 }).addTo(map);
                }

                if (pharmacy && pharmacy.local_lat) {
                    const icon = L.divIcon({ html: `<div class="animate-bounce bg-red-600 p-2 rounded-full border-2 border-white shadow-2xl"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></svg></div>`, className: '', iconSize: [32, 32], iconAnchor: [16, 16] });
                    L.marker([pharmacy.local_lat, pharmacy.local_lng], { icon }).addTo(map);
                }

                reports.forEach(r => {
                    const type = REPORT_TYPES.find(t => t.id === r.type) || REPORT_TYPES[0];
                    const icon = L.divIcon({ html: `<div style="background:${type.color};" class="w-10 h-10 rounded-full flex items-center justify-center border-2 border-white shadow-xl hover:scale-110 active:scale-95 transition-transform"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">${type.svg}</svg></div>`, className: '', iconSize: [40, 40], iconAnchor: [20, 20] });
                    L.marker([r.lat, r.lng], { icon }).addTo(map).on('click', (e) => { L.DomEvent.stopPropagation(e); onMarkerClick(r); });
                });
            }, [reports, userLoc, pharmacy]);
            return null;
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>